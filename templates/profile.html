<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }

    .container {
      display: flex;
      max-width: 1200px;
      margin: 20px auto;
    }

    /* Left Sidebar */
    .sidebar {
      width: 25%;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .profile-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto;
      display: block;
    }

    .profile-info {
      text-align: center;
      margin-top: 10px;
    }

    .profile-info h2 {
      margin: 10px 0;
      font-size: 18px;
    }

    .profile-info p {
      color: #666;
      font-size: 14px;
    }

    .menu {
      margin-top: 20px;
    }

    .menu a {
      display: block;
      text-decoration: none;
      color: #333;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: center;
    }

    .menu a:hover {
      background: #007bff;
      color: #fff;
    }

    .toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 5px;
      padding: 10px;
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1;
      font-size: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  
    .toast.show {
      visibility: visible;
      animation: fadeInOut 4s ease;
    }
  
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      10%, 90% { opacity: 1; }
    }

    /* Main Content */
    .main-content {
      width: 50%;
      margin: 0 20px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .post {
      border-bottom: 1px solid #ddd;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    .post:last-child {
      border-bottom: none;
    }

    .post h3 {
      margin: 0 0 10px;
    }

    .post p {
      margin: 0 0 10px;
      color: #555;
    }

    .post img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 10px;
    }

    .search-user {
      margin: 20px;
      text-align: center;
    }
  
    .search-user input {
      padding: 10px;
      width: 200px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
  
    .search-user button {
      padding: 10px 15px;
      font-size: 16px;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  
    .search-user button:hover {
      background-color: #0056b3;
    }

    /* Right Sidebar */
    .right-sidebar {
      width: 25%;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .right-sidebar h3 {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .movie {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .movie button {
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .movie button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <!-- 用戶頭像和基本信息 -->
      <img src="https://via.placeholder.com/80" alt="Profile" class="profile-pic">
      <div class="profile-info">
        <h2>{{ user.username }}</h2>
        <p>{{ user.email }}</p>
        <p>UID:{{ user.id}}</p>
      </div>
      <!-- 菜單 -->
      <div class="menu">
        <div class="favorite-movie-btn">
          <button onclick="window.location.href='{{ url_for('main.user_friends') }}'">
            我的朋友
          </button>
        </div>
        <div class="favorite-movie-btn">
          <button onclick="window.location.href='{{ url_for('main.my_reviews') }}'">
            我的評論
          </button>
        </div>
        <div class="favorite-movie-btn">
          <button onclick="window.location.href='{{ url_for('main.my_list') }}'">
            收藏電影
          </button>
        </div>
        <div class="favorite-movie-btn">
          <button onclick="window.location.href='{{ url_for('main.profile_edit') }}'">
            編輯資料
          </button>
        </div>
      </div>
    </div>
  
    <!-- Main Content -->
    <div class="main-content">
      <article class="post">
        <h3>董座豪宅必備私人電影院</h3>
        <p>私人電影院設施不僅能提升董座家庭的娛樂品味，也讓家人能在繁忙的工作與生活中找到放鬆與享受的空間。從設計到選擇設備，每個環節都必須精心規劃，以確保家庭成員在居家影院中獲得最極致的娛樂體驗。</p>
        <img src="{{ url_for('static', filename='images/article1.png') }}" alt="文章圖片 1">
      </article>
  
      <article class="post">
        <h3>「映台北」影展</h3>
        <p>「映台北」影展，透過六部與台北相關的經典電影，佈置限定版復古場景，讓你穿越時光回到過去的年代，還可以在館內尋寶就有機會拿到限量「映台北帆布提袋」。</p>
        <img src="{{ url_for('static', filename='images/article2.png') }}" alt="文章圖片 2">
      </article>
    </div>
  
    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <div class="friend-requests-section">
        <h3>收到的好友邀请</h3>
        <ul id="friend-requests">
        <!-- 动态加载好友邀请 -->
        </ul>
      </div>
      

      <!-- 搜尋用戶 -->
      <div class="search-user">
        <label for="searchUserId" style="display:block; margin-bottom: 8px; font-weight: bold;">發送好友邀請</label>
        <input type="text" id="searchUserId" placeholder="輸入 User ID">
        <button onclick="sendFriendRequest()">發送好友邀請</button>
      </div>
      
      <div id="toast" class="toast"></div>
      
      <!-- 已預定的電影 -->
      <h3>已預定的電影</h3>
      {% for movie in reserved_movies %}
      <div class="movie">
        <p><strong>{{ movie.title }}</strong></p>
        <p>{{ movie.showtime.strftime('%Y-%m-%d %H:%M') }}</p>
      </div>
      {% endfor %}
      
      <script>
        // 顯示 Toast 提示
        function showToast(message) {
          const toast = document.getElementById('toast');
          toast.textContent = message; // 設定顯示的訊息
          toast.classList.add('show');
          setTimeout(() => {
            toast.classList.remove('show');
          }, 4000); // 4 秒後自動隱藏
        }
      
        // 發送好友邀請
        function sendFriendRequest() {
          const uid = document.getElementById('friend-uid').value;  // 獲取用戶輸入的 UID
        
          fetch('/send-friend-request', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'  // 設置請求頭部為 JSON 格式
            },
            body: JSON.stringify({ uid: uid })  // 將 UID 包裝為 JSON 格式
          })
          .then(response => response.json())  // 解析回應的 JSON 數據
          .then(data => {
            if (data.message) {
              showToast(data.message);  // 顯示成功的提示信息
            } else if (data.error) {
              showToast(data.error);  // 顯示錯誤的提示信息
            }
          })
          .catch(error => {
            console.error('發送好友邀請失敗:', error);
            showToast('發送好友邀請時出現錯誤');
          });
        }
  
        function loadFriendRequests() {
          fetch('/get-friend-requests',{
            method: 'GET',
            credentials: 'include', 
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('请求失败，状态码：' + response.status);
              }
              return response.json();
            })
            .then(data => {
              console.log(data);
              const requestList = document.getElementById('friend-requests');
              requestList.innerHTML = ''; // 清空现有内容
              if (data.requests && data.requests.length > 0) {
                data.requests.forEach(request => {
                  const li = document.createElement('li');
                  li.innerHTML = `
                    <span>${request.sender_username} 想成为你的好友</span>
                    <button onclick="respondFriendRequest(${request.id}, 'accept')">接受</button>
                    <button onclick="respondFriendRequest(${request.id}, 'reject')">拒绝</button>
                ` ;
                  requestList.appendChild(li);
                });
                } else {
                  requestList.innerHTML = '<li>暂无好友邀请</li>';
                }
              })
              .catch(error => {
                console.error('加载好友邀请失败:', error);
              });
          }
      
        // 响应好友邀请
        function respondFriendRequest(requestId, action) {
          fetch('/respond-friend-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ request_id: requestId, action: action })
          })
          .then(response => response.json())
          .then(data => {
            alert(data.message || data.error);
            loadFriendRequests(); // 更新好友邀请列表
          })
          .catch(error => {
            console.error('处理好友邀请失败:', error);
          });
        }
      
        // 页面加载时自动加载好友邀请
        document.addEventListener('DOMContentLoaded', loadFriendRequests);
      </script>